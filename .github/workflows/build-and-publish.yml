# Github Actions 작성 가이드 : https://docs.github.com/actions
# Node 작성 가이드 : https://docs.github.com/en/actions/publishing-packages/publishing-nodejs-packages
# Nexus 작성 가이드 : https://github.com/marketplace/actions/nexus-repository-publisher-for-github-actions

# NPM 기본 registry 경로 = https://registry.npmjs.org/
# -> 외부 라이브러리 참조 시 사용한다. (Vue, Vite...)
# 사설 registry 경로 = https://nexus.ajdlabs.kr/repository/npm-private/
# -> fronkk 컴포넌트의 변경사항 참조 혹은 외부에서의 참조 시 사용한다

### 웹훅 시나리오
# 1. local에서 변경사항 발생 & remote 브랜치 업데이트
# 2. remote develop - 병합
# 3. remote main - 병합 - 여기까지는 작업자가 반영해야 한다
# 4. remote main - 빌드 ** 여기부터 yml 스크립트로 실행된다
# 5. remote main - 배포

name: Automate Build and Publish

on:
  merge_group:
    types: [ checks_requested ]

jobs:
  build: # 임의로 작성한 id, 변경 가능 (프로젝트 고유 변수명처럼 사용)
    runs-on: ubuntu-latest # 프로세스를 실행할 환경
    steps: # 실행될 스크립트
      - run: npm build

  publish:
    needs: [ build ] # build 이후 순차적으로 publish이 되도록 설정
    runs-on: ubuntu-latest
    steps:
      # 코드 저장소의 코드를 CI 서버로 가지고온다
      - uses: actions/checkout@v4
      # Setup .npmrc file to publish to npm / .npmrc에서 사설 registry를 관리하므로 생략 불가능!
      - uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          registry-url: 'https://nexus.ajdlabs.kr/repository/npm-private/'
      - run: npm ci # package-lock.json에 명시된 패키지를 nodE_modules에 적재
      - run: npm publish # auth 필요한지 확인하기 TODO